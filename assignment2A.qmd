---
title: "assignment2A"
author: "XiaoFei"
format: html
editor: visual
---

## Approach

This assignment requires connect PostgreSQL to R. My plan is to create a data set about movie-rating in PstgreSQL, then query and do analysis on the data set directly from R to show summary of movie review.

Key areas that I'm hoping to practice through this task is to create, edit database in PostgreSQL, and connect them securely in R. The code will be made public therefore password shouldn't be shown inside the code for security concern.

## Connect to PostgreSQL

To create the connection withou reveal password in code, we can create a environmental variable to store database password when connecting PostgreSQL to R.

```{r}
library(DBI)
library(RPostgres)
library(dplyr)
library(ggplot2)
library(tidyr)

# set up the database password to be stored in environment variable so it won't be shwon in code here.
db_password <- Sys.getenv("DB_PASSWORD")
db_user <- "postgres"
db_name <- "xmbd"
db_host <- "localhost"
db_port <- "5432"

con <- dbConnect(
  Postgres(),
  dbname = "xmdb",
  host = "localhost",
  port = 5432,
  user = "postgres",
  password = Sys.getenv("DB_PASSWORD")
)

data <- dbGetQuery(con, "
    SELECT u.name, m.title, r.rating
    FROM ratings r
    JOIN users u ON r.user_id = u.user_id
    JOIN movies m ON r.movie_id = m.movie_id
")

print(head(data))
```

## Data Exploration 

As shown in the result, there are 6 movies Zootopia 2, Dog Man, Superman, Elio, Avatar 3 and Send help. When asking user for 1-5 rating for each movie, they can not provide rating to movie that haven't watch, a missing value will be recorded in such case. Before do anlaysis, we will have to figure out a way to hand missing data, either ignore them or use a way to imputed those missing values. In this case, I choose to use the average to fill in the missing value. Now we are ready for next section, data analysis.

```{r}
full_data <- dbGetQuery(con, "
    SELECT u.name, m.title, m.genre, r.rating
    FROM ratings r
    JOIN users u ON r.user_id = u.user_id
    JOIN movies m ON r.movie_id = m.movie_id
")

# Create a user-movie rating matrix 
rating_matrix <- full_data |>
  select(name, title, rating) |>
  pivot_wider(
    names_from = title,
    values_from = rating,
    values_fill = NA ) #

print(rating_matrix)

# check missing data
missing_analysis <- rating_matrix |>
  summarise(across(where(is.numeric), ~sum(is.na(.)))) |>
  pivot_longer(everything(), names_to = "movie", values_to = "missing_count")

print(missing_analysis)

# to handle missing data, we replace NA with movie average
movie_means <- full_data |>
  group_by(title) |>
  summarise(movie_mean = mean(rating, na.rm = TRUE))

imputed_data <- full_data |>
  left_join(movie_means, by = "title") |>
  mutate(rating_imputed = ifelse(is.na(rating), movie_mean, rating))


```

## Data Analysis 

Here I print out statistics in list to show movie name, average ratings and rating count. A bar plot is create to present the summary in order of high to low ratings. Movie Elio receives the highest rating. Followed by Zootopia 2, Superman and Send Help being on the second highest rating.

```{r}
#  statistics
movie_stats <- full_data |>
  group_by(title, genre) |>
  summarise(
    avg_rating = mean(rating, na.rm = TRUE),
    rating_count = n(),
    .groups = "drop"
  ) |>
  arrange(desc(avg_rating))

print(movie_stats)

# Average rating 
user_stats <- full_data |>
  group_by(name) |>
  summarise(
    avg_rating = mean(rating, na.rm = TRUE),
    movies_rated = n(),
    .groups = "drop"
  ) |>
  arrange(desc(avg_rating))

print(user_stats)

# plot
ggplot(movie_stats, aes(x = reorder(title, avg_rating), y = avg_rating, fill = genre)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(title = "Average Movie Ratings", x = "Movie", y = "Average Rating (1-5)") +
  theme_minimal()



dbDisconnect(con)
```

## Conclusion

Total 5 users provided their moving rating to 6 movies, we edit their ratings into database set up in PostegreSQL. In R, connection was established and data analysis show none of the 5 users have seen all movies from the list, which is understandable since those movies were all released recently. From their feedback, Elio shows the highest rating given by user Zac and Joe.

If to expand this analysis further, we should certainly ask for more user input to make result more reliable as 1 or 2 low rating won't have such influence to the result.
